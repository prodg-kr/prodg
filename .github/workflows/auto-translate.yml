name: pronews.jp 자동 번역 및 게시 v4

on:
  schedule:
    # 매일 오전 7시 (KST) = UTC 22:00 (전날)
    - cron: '0 22 * * *'

  # 수동 실행
  workflow_dispatch:
    inputs:
      force_update:
        description: '이미 게시된 기사도 재처리 (true/false)'
        required: false
        default: 'false'
      gemini_model:
        description: 'Gemini 모델 변경 (기본: gemini-2.5-flash)'
        required: false
        default: 'gemini-2.5-flash'
      groq_model:
        description: 'Groq 모델 변경 (기본: llama-3.3-70b-versatile)'
        required: false
        default: 'llama-3.3-70b-versatile'

jobs:
  translate-and-post:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # posted_articles.json git 커밋/푸시 권한

    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4

    - name: Python 설정
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: 의존성 설치
      run: pip install -r requirements.txt

    - name: 이전 게시 기록 복원
      uses: actions/cache@v4
      with:
        path: posted_articles.json
        key: posted-articles-${{ github.run_id }}
        restore-keys: |
          posted-articles-

    - name: pronews.jp 번역 및 게시 실행
      env:
        WP_USER: ${{ secrets.WP_USER }}
        WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
        GEMINI_MODEL: ${{ github.event.inputs.gemini_model || 'gemini-2.5-flash' }}
        GROQ_MODEL: ${{ github.event.inputs.groq_model || 'llama-3.3-70b-versatile' }}
      run: python translate_and_post.py

    - name: 게시 기록 저장
      uses: actions/cache/save@v4
      if: always()
      with:
        path: posted_articles.json
        key: posted-articles-${{ github.run_id }}

    - name: 완료 알림
      if: always()
      run: |
        echo "✅ 작업 완료: $(date)"
        echo "다음 실행: 내일 오전 7시 (KST)"
